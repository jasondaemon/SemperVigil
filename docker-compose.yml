services:
  # 1) Admin API (internal)
  admin:
    build:
      context: .
      dockerfile: docker/ingest/Dockerfile
    container_name: sempervigil-admin
    env_file:
      - .env
    environment:
      SV_ENV: ${SV_ENV:-dev}
      SV_DATA_DIR: /data
      SV_CONFIG_PATH: /config/config.yml
      SV_LOG_LEVEL: ${SV_LOG_LEVEL:-INFO}
      SV_UMASK: ${SV_UMASK:-002}
    command:
      - sh
      - -lc
      - |
        set -e
        umask ${SV_UMASK:-002}
        mkdir -p /data /site /config
        uvicorn sempervigil.admin:app --host 0.0.0.0 --port 8000
    ports:
      - "0.0.0.0:${SV_ADMIN_PORT:-8001}:8000"
    user: "${SV_UID:-1000}:${SV_GID:-1000}"
    volumes:
      - sv_data:/data
      - ./config:/config:ro
    networks:
      - svnet
    restart: unless-stopped

  # 2) Worker (internal)
  worker:
    build:
      context: .
      dockerfile: docker/ingest/Dockerfile
    container_name: sempervigil-worker
    env_file:
      - .env
    environment:
      SV_ENV: ${SV_ENV:-dev}
      SV_DATA_DIR: /data
      SV_CONFIG_PATH: /config/config.yml
      SV_LOG_LEVEL: ${SV_LOG_LEVEL:-INFO}
      SV_UMASK: ${SV_UMASK:-002}
    command:
      - sh
      - -lc
      - |
        set -e
        umask ${SV_UMASK:-002}
        mkdir -p /data /site /config
        sempervigil-worker
    user: "${SV_UID:-1000}:${SV_GID:-1000}"
    volumes:
      - sv_data:/data
      - sv_site:/site
      - ./config:/config:ro
    networks:
      - svnet
    restart: unless-stopped

  # 3) Builder (on-demand Hugo build)
  builder:
    build:
      context: .
      dockerfile: docker/builder/Dockerfile
    container_name: sempervigil-builder
    env_file:
      - .env
    environment:
      SV_UMASK: ${SV_UMASK:-002}
      SV_HUGO_BASEURL: ${SV_HUGO_BASEURL:-http://localhost:${SV_WEB_PORT:-8080}/}
      HUGO_CACHEDIR: /tmp/hugo_cache
    working_dir: /repo
    volumes:
      - .:/repo:ro
      - sv_site:/site
      - sv_hugo_cache:/tmp/hugo_cache
      # Let Hugo write generated resources (image pipeline, etc.)
      - sv_hugo_resources:/repo/site/resources
      # If your theme uses Hugo Modules, this prevents module cache pain too
      - sv_hugo_modules:/tmp/hugo_modules
    command:
      - sh
      - -lc
      - |
        set -e
        umask ${SV_UMASK:-002}
        mkdir -p /site /tmp/hugo_cache /tmp/hugo_modules
        echo "Building Hugo: source=/repo/site -> dest=/site (baseURL=${SV_HUGO_BASEURL})"
        hugo --source /repo/site --destination /site --baseURL "${SV_HUGO_BASEURL}" --noBuildLock
    networks:
      - svnet

  # 4) Static site server (public)
  web:
    image: nginxinc/nginx-unprivileged:alpine
    container_name: sempervigil-web
    ports:
      - "${SV_WEB_PORT:-8080}:8080"
    volumes:
      - sv_site:/usr/share/nginx/html:ro
    networks:
      - svnet
    restart: unless-stopped

  # 5) Test runner (image-only, no NFS)
  test:
    build:
      context: .
      dockerfile: docker/ingest/Dockerfile
      args:
        INSTALL_TEST_DEPS: "1"
    env_file:
      - .env
    user: "${SV_UID:-1000}:${SV_GID:-1000}"
    volumes:
      - sv_data:/data
      - sv_site:/site
    working_dir: /app
    command: ["python", "-m", "pytest", "-q", "-p", "no:cacheprovider"]

volumes:
  sv_data:
  sv_site:
  sv_hugo_cache:
  sv_hugo_resources:
  sv_hugo_modules:

networks:
  svnet:
    driver: bridge
