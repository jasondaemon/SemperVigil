services:
  # 0) PostgreSQL (internal)
  db:
    image: postgres:16
    container_name: sempervigil-db
    environment:
      POSTGRES_DB: ${SV_DB_NAME:-sempervigil}
      POSTGRES_USER: ${SV_DB_USER:-sempervigil}
      POSTGRES_PASSWORD: ${SV_DB_PASSWORD:-sempervigil}
    volumes:
      - sempervigil_pgdata:/var/lib/postgresql/data
    networks:
      - svnet
    restart: unless-stopped

  # 1) Admin API (internal)
  admin:
    build:
      context: .
      dockerfile: docker/ingest/Dockerfile
    container_name: sempervigil-admin
    env_file:
      - .env
    environment:
      SV_ENV: ${SV_ENV:-dev}
      SV_DATA_DIR: /data
      SV_LOG_LEVEL: ${SV_LOG_LEVEL:-INFO}
      SV_LOG_FILE: /data/logs/admin.log
      SV_UMASK: ${SV_UMASK:-002}
      SV_ADMIN_TOKEN: ${SV_ADMIN_TOKEN:-}
      SV_DB_URL: ${SV_DB_URL:-}
    command:
      - sh
      - -lc
      - |
        set -e
        umask ${SV_UMASK:-002}
        sh /tools/ensure-dirs.sh
        uvicorn sempervigil.admin:app --host 0.0.0.0 --port 8000
    ports:
      - "0.0.0.0:${SV_ADMIN_PORT:-8001}:8000"
    user: "${SV_UID:-1000}:${SV_GID:-1000}"
    volumes:
      - sv_data:/data
      - ./tools:/tools:ro
    networks:
      - svnet
    restart: unless-stopped

    # 2) Worker (internal)
  # Recommended scaling: worker_fetch=2, worker_llm=1
  worker_fetch:
    build:
      context: .
      dockerfile: docker/ingest/Dockerfile
    # NOTE: no container_name so we can scale this service
    hostname: worker-fetch
    labels:
      com.sempervigil.role: "worker"
      com.sempervigil.queue: "fetch"
      com.sempervigil.service: "worker_fetch"
    env_file:
      - .env
    environment:
      SV_ENV: ${SV_ENV:-dev}
      SV_DATA_DIR: /data
      SV_LOG_LEVEL: ${SV_LOG_LEVEL:-INFO}
      SV_LOG_FILE: /data/logs/worker.log
      SV_UMASK: ${SV_UMASK:-002}
      SV_DB_URL: ${SV_DB_URL:-}
      SV_WORKER_ONLY_TYPES: "ingest_source,html_index,rss_index,fetch_article_content,write_article_markdown,cve_sync"
    command:
      - sh
      - -lc
      - |
        set -e
        umask ${SV_UMASK:-002}
        sh /tools/ensure-dirs.sh
        sempervigil-worker
    user: "${SV_UID:-1000}:${SV_GID:-1000}"
    volumes:
      - sv_data:/data
      - sv_site:/site
      - ./tools:/tools:ro
    networks:
      - svnet
    restart: unless-stopped

  worker_llm:
    build:
      context: .
      dockerfile: docker/ingest/Dockerfile
    # NOTE: no container_name so we can scale this service
    hostname: worker-llm
    labels:
      com.sempervigil.role: "worker"
      com.sempervigil.queue: "llm"
      com.sempervigil.service: "worker_llm"
    env_file:
      - .env
    environment:
      SV_ENV: ${SV_ENV:-dev}
      SV_DATA_DIR: /data
      SV_LOG_LEVEL: ${SV_LOG_LEVEL:-INFO}
      SV_LOG_FILE: /data/logs/worker.log
      SV_UMASK: ${SV_UMASK:-002}
      SV_DB_URL: ${SV_DB_URL:-}
      SV_WORKER_ONLY_TYPES: "summarize_article_llm"
      SV_LLM_MAX_INFLIGHT: "1"
      SV_WORKER_CONCURRENCY: "1"
    command:
      - sh
      - -lc
      - |
        set -e
        umask ${SV_UMASK:-002}
        sh /tools/ensure-dirs.sh
        sempervigil-worker
    user: "${SV_UID:-1000}:${SV_GID:-1000}"
    volumes:
      - sv_data:/data
      - sv_site:/site
      - ./tools:/tools:ro
    networks:
      - svnet
    restart: unless-stopped

  # 3) Builder (on-demand Hugo build)
  builder:
    profiles:
      - build
    build:
      context: .
      dockerfile: docker/builder/Dockerfile
    container_name: sempervigil-builder
    env_file:
      - .env
    environment:
      SV_UMASK: ${SV_UMASK:-002}
      SV_LOG_FILE: /data/logs/builder.log
      SV_HUGO_BASEURL: ${SV_HUGO_BASEURL:-http://localhost:${SV_WEB_PORT:-8080}/}
      HUGO_CACHEDIR: /tmp/hugo_cache
      SV_DB_URL: ${SV_DB_URL:-}
    working_dir: /repo
    user: "${SV_UID:-1000}:${SV_GID:-1000}"
    volumes:
      - .:/repo:ro
      - sv_data:/data              # âœ… add this
      - sv_site:/site
      - sv_hugo_cache:/tmp/hugo_cache
      # Let Hugo write generated resources (image pipeline, etc.)
      - sv_hugo_resources:/repo/site/resources
      # If your theme uses Hugo Modules, this prevents module cache pain too
      - sv_hugo_modules:/tmp/hugo_modules
      - ./tools:/tools:ro
    command: ["sempervigil-builder", "--once"]
    networks:
      - svnet

  # 4) Static site server (public)
  web:
    image: nginxinc/nginx-unprivileged:alpine
    container_name: sempervigil-web
    ports:
      - "${SV_WEB_PORT:-8080}:8080"
    volumes:
      - sv_site:/usr/share/nginx/html:ro
    networks:
      - svnet
    restart: unless-stopped

  # 5) Test runner (image-only, no NFS)
  test:
    profiles:
      - test
    build:
      context: .
      dockerfile: docker/ingest/Dockerfile
      args:
        INSTALL_TEST_DEPS: "1"
    env_file:
      - .env
    user: "${SV_UID:-1000}:${SV_GID:-1000}"
    volumes:
      - sv_data:/data
      - sv_site:/site
    working_dir: /app
    command: ["python", "-m", "pytest", "-q", "-p", "no:cacheprovider"]
    environment:
      SV_DB_URL: ${SV_DB_URL:-}

volumes:
  sv_data:
  sv_site:
  sv_hugo_cache:
  sv_hugo_resources:
  sv_hugo_modules:
  sempervigil_pgdata:

networks:
  svnet:
    driver: bridge
