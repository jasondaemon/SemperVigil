services:
  # 1) Admin API (internal)
  admin:
    build:
      context: .
      dockerfile: docker/ingest/Dockerfile
    container_name: sempervigil-admin
    env_file:
      - .env
    environment:
      SV_ENV: ${SV_ENV:-dev}
      SV_DATA_DIR: ${SV_DATA_DIR:-/data}
      SV_CONFIG_PATH: ${SV_CONFIG_PATH:-/config/config.yml}
      SV_LOG_LEVEL: ${SV_LOG_LEVEL:-INFO}
    command: ["uvicorn", "sempervigil.admin:app", "--host", "0.0.0.0", "--port", "8000"]
    ports:
      - "127.0.0.1:8001:8000"
    user: "${SV_UID:-1000}:${SV_GID:-1000}"
    volumes:
      - ./config:/config:ro
      - ./data:/data
    networks:
      - svnet

  # 2) Worker (internal)
  worker:
    build:
      context: .
      dockerfile: docker/ingest/Dockerfile
    container_name: sempervigil-worker
    env_file:
      - .env
    environment:
      SV_ENV: ${SV_ENV:-dev}
      SV_DATA_DIR: ${SV_DATA_DIR:-/data}
      SV_CONFIG_PATH: ${SV_CONFIG_PATH:-/config/config.yml}
      SV_LOG_LEVEL: ${SV_LOG_LEVEL:-INFO}
    command: ["sempervigil-worker"]
    user: "${SV_UID:-1000}:${SV_GID:-1000}"
    volumes:
      - ./config:/config:ro
      - ./data:/data
      - ./site:/site
    networks:
      - svnet

  # 3) Builder (internal)
  builder:
    build:
      context: .
      dockerfile: docker/builder/Dockerfile
    container_name: sempervigil-builder
    env_file:
      - .env
    environment:
      SV_ENV: ${SV_ENV:-dev}
      SV_DATA_DIR: ${SV_DATA_DIR:-/data}
      SV_CONFIG_PATH: ${SV_CONFIG_PATH:-/config/config.yml}
      SV_LOG_LEVEL: ${SV_LOG_LEVEL:-INFO}
    command: ["sempervigil-builder"]
    user: "${SV_UID:-1000}:${SV_GID:-1000}"
    volumes:
      - ./config:/config:ro
      - ./data:/data
      - ./site:/site
    networks:
      - svnet

  # 4) Static site server (public)
  web:
    image: nginxinc/nginx-unprivileged:alpine
    container_name: sempervigil-web
    ports:
      - "8080:8080"
    volumes:
      - ./site/public:/usr/share/nginx/html:ro
    networks:
      - svnet

networks:
  svnet:
    driver: bridge
