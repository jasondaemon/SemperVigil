services:
  # 1) Admin API (internal)
  admin:
    build:
      context: .
      dockerfile: docker/ingest/Dockerfile
    container_name: sempervigil-admin
    env_file:
      - .env
    environment:
      SV_ENV: ${SV_ENV:-dev}
      SV_DATA_DIR: /data
      SV_CONFIG_PATH: /config/config.yml
      SV_LOG_LEVEL: ${SV_LOG_LEVEL:-INFO}
      SV_UMASK: ${SV_UMASK:-002}
    command: ["sh", "-lc", "/tools/ensure-dirs.sh && uvicorn sempervigil.admin:app --host 0.0.0.0 --port 8000"]
    ports:
      - "127.0.0.1:${SV_ADMIN_PORT:-8001}:8000"
    user: "${SV_UID:-1000}:${SV_GID:-1000}"
    volumes:
      - sv_data:/data
      - ./config:/config:ro
      - ./tools:/tools:ro
    networks:
      - svnet
    restart: unless-stopped

  # 2) Worker (internal)
  worker:
    build:
      context: .
      dockerfile: docker/ingest/Dockerfile
    container_name: sempervigil-worker
    env_file:
      - .env
    environment:
      SV_ENV: ${SV_ENV:-dev}
      SV_DATA_DIR: /data
      SV_CONFIG_PATH: /config/config.yml
      SV_LOG_LEVEL: ${SV_LOG_LEVEL:-INFO}
      SV_UMASK: ${SV_UMASK:-002}
    command: ["sh", "-lc", "/tools/ensure-dirs.sh && sempervigil-worker"]
    user: "${SV_UID:-1000}:${SV_GID:-1000}"
    volumes:
      - sv_data:/data
      - sv_site:/site
      - ./config:/config:ro
      - ./tools:/tools:ro
    networks:
      - svnet
    restart: unless-stopped

  # 3) Builder (on-demand Hugo build)
  builder:
    build:
      context: .
      dockerfile: docker/builder/Dockerfile
    container_name: sempervigil-builder
    env_file:
      - .env
    environment:
      SV_UMASK: ${SV_UMASK:-002}
      SV_HUGO_BASEURL: "${SV_HUGO_BASEURL:-http://localhost:${SV_WEB_PORT:-8080}/}"
    user: "${SV_UID:-1000}:${SV_GID:-1000}"
    volumes:
      - sv_data:/data
      - sv_site:/site
      - ./tools:/tools:ro
      - ./config:/config:ro
    command:
      - sh
      - -lc
      - |
        /tools/ensure-dirs.sh
        # build Hugo from the repo's ./site folder into the sv_site volume
        hugo --source /app/site --destination /site --baseURL "${SV_HUGO_BASEURL}"
    networks:
      - svnet

  # 4) Static site server (public)
  web:
    image: nginxinc/nginx-unprivileged:alpine
    container_name: sempervigil-web
    ports:
      - "${SV_WEB_PORT:-8080}:8080"
    volumes:
      - sv_site:/usr/share/nginx/html:ro
    networks:
      - svnet
    restart: unless-stopped

  # 5) Test runner (image-only, no NFS)
  test:
    build:
      context: .
      dockerfile: docker/ingest/Dockerfile
      args:
        INSTALL_TEST_DEPS: "1"
    env_file:
      - .env
    user: "${SV_UID:-1000}:${SV_GID:-1000}"
    volumes:
      - sv_data:/data
      - sv_site:/site
    working_dir: /app
    command: ["python", "-m", "pytest", "-q"]

volumes:
  sv_data:
  sv_site:

networks:
  svnet:
    driver: bridge