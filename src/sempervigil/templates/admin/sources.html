{% extends "admin/base.html" %}
{% set nav_active = "system" %}
{% set nav_subactive = "sources" %}
{% set nav_subactive = "sources" %}
{% block content %}
  <section class="panel">
    <h2>Add / Edit Source</h2>
    <form id="source-form">
      <input type="hidden" id="source-id">
      <div class="grid">
        <label>Name<input type="text" id="source-name" required></label>
        <label>Kind
          <select id="source-kind">
            <option value="rss">rss</option>
            <option value="html">html</option>
          </select>
        </label>
        <label>URL<input type="url" id="source-url" required></label>
        <label>Interval (min)<input type="number" id="source-interval" value="60"></label>
        <label>Tags (comma)<input type="text" id="source-tags"></label>
        <label class="checkbox"><input type="checkbox" id="source-enabled" checked> Enabled</label>
      </div>
      <div class="actions">
        <button class="btn" type="submit">Save Source</button>
        <button class="btn secondary" type="button" id="source-reset">Reset</button>
      </div>
    </form>
  </section>

  <section class="panel">
    <a id="test-sources"></a>
    <h2>Sources</h2>
    <table id="sources-table">
      <thead>
        <tr>
          <th>Enabled</th>
          <th>Name</th>
          <th>Kind</th>
          <th>URL</th>
          <th>Interval</th>
          <th>Status</th>
          <th>Articles 24h</th>
          <th>Accepted Last Run</th>
          <th>Tags</th>
          <th>Last OK</th>
          <th>Last Error</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for source in sources %}
        <tr data-source-id="{{ source.id }}">
          <td>
            <input type="checkbox" class="toggle-enabled" {% if source.enabled %}checked{% endif %}>
          </td>
          <td class="source-name">{{ source.name }}</td>
          <td class="source-kind">{{ source.kind or "" }}</td>
          <td class="source-url mono wrap">{{ source.url }}</td>
          <td class="source-interval">{{ source.interval_minutes }}</td>
          <td>
            {% if source.last_error %}
              <span class="status-pill status-error">Error</span>
            {% elif source.last_ok_at %}
              <span class="status-pill status-ok">OK</span>
            {% else %}
              <span class="status-pill">Unknown</span>
            {% endif %}
          </td>
          <td>{{ source.articles_24h }}</td>
          <td>{{ source.accepted_last_run }}</td>
          <td class="source-tags">{{ source.tags | join(", ") }}</td>
          <td>{{ source.last_ok_at or "" }}</td>
          <td class="truncate">{{ source.last_error or "" }}</td>
          <td class="table-actions">
            <button class="btn small test-source" type="button">Test</button>
            <button class="btn small secondary history-source" type="button">History</button>
            <button class="btn small secondary edit-source" type="button">Edit</button>
            <button class="btn small danger delete-source" type="button">Delete</button>
          </td>
        </tr>
        <tr class="test-result" data-source-id="{{ source.id }}" style="display:none;">
          <td colspan="12">
            <div class="test-summary"></div>
            <details class="test-details">
              <summary>Details</summary>
              <pre class="mono test-raw"></pre>
            </details>
          </td>
        </tr>
        <tr class="history-result" data-source-id="{{ source.id }}" style="display:none;">
          <td colspan="12">
            <div class="history-table"></div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
{% endblock %}
